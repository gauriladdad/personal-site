---
import Layout from '../layouts/Layout.astro';
---

<Layout>
  <main>
    {/* Header */}
    <header className="text-center" style="margin-bottom: 3rem;">
      <h1 class="page-title">Kids News & Activities</h1>
      <p class="text-muted">
        Calm, friendly stories for kids aged 6–9 · Updated weekly
      </p>
    </header>

    {/* Loading State */}
    <div id="loading" class="text-center" style="margin: 2rem 0;">
      <p>Loading the latest news...</p>
    </div>

    {/* Error State */}
    <div id="error" class="text-center" style="color: red; display: none;">
      <p>Could not load news. Please check back later!</p>
    </div>

    {/* Stories Container */}
    <section id="stories-container">
      {/* Stories will be injected here via JavaScript */}
    </section>

    {/* Archives Footer */}
    <footer id="archive-footer" class="archive-footer" style="display: none;">
      <h3 class="archive-title">Past days</h3>
      <ul id="archive-list" class="archive-list">
        {/* Archive links injected here */}
      </ul>
    </footer>
  </main>
</Layout>

<script>
  // TODO: Replace with your actual S3 Bucket URL after you create it in AWS Console
  // Example: https://personal-site-news-yourname.s3.us-east-1.amazonaws.com
  const S3_BASE_URL = 'https://amzn-s3-news-demo-bucket.s3.us-east-2.amazonaws.com';

  async function fetchJson(filename) {
    const response = await fetch(`${S3_BASE_URL}/${filename}`);
    if (!response.ok) throw new Error(`Failed to fetch ${filename}`);
    return await response.json();
  }

  function renderStories(newsData) {
    const container = document.getElementById('stories-container');
    container.innerHTML = ''; // Clear loading/existing

    newsData.stories.forEach(story => {
      const article = document.createElement('article');
      article.className = 'news-article';

      const sectionsHtml = story.section.map(para => `<p>${para}</p>`).join('');
      
      article.innerHTML = `
        <h2 class="news-heading">${story.title}</h2>
        <p class="meta-info">
          <span style="color: var(--color-accent);">${newsData.date}</span>
          •
          ${story.location}
        </p>
        <div class="news-content">
          ${sectionsHtml}
        </div>
        <div class="why-it-matters">
          <span class="why-label">Why it matters</span>
          <p>${story.why_it_matters || ''}</p>
        </div>
      `;
      container.appendChild(article);
    });
  }

  function renderArchives(indexData, currentFile) {
    const footer = document.getElementById('archive-footer');
    const list = document.getElementById('archive-list');
    
    // Filter out current file and sort simple string dates
    // Assuming indexData.archive is list of "YYYY-MM-DD"
    // Also include 'latest' if we are viewing an archive
    
    // Combine all dates unique
    const allDates = [...new Set([...(indexData.archive || []), indexData.latest])];
    
    // Simple verification content exists
    if (allDates.length <= 1) return; 

    footer.style.display = 'block';
    list.innerHTML = '';

    allDates.sort().reverse().forEach(date => {
       // logic: if date is the one we are viewing, skip or mark active? 
       // For now just list others
       if (date === currentDateStr) return; 

       const li = document.createElement('li');
       const a = document.createElement('a');
       a.href = `/?date=${date}`;
       a.className = 'archive-link';
       a.textContent = date;
       li.appendChild(a);
       list.appendChild(li);
    });
  }
  
  // Global state
  let currentDateStr = '';

  async function init() {
    const loading = document.getElementById('loading');
    const error = document.getElementById('error');
    
    try {
      // 1. Get query param
      const urlParams = new URLSearchParams(window.location.search);
      const queryDate = urlParams.get('date');

      // 2. Fetch Index
      const indexData = await fetchJson('index.json');
      
      // 3. Determine target date
      currentDateStr = queryDate || indexData.latest;
      
      // 4. Fetch News
      const newsData = await fetchJson(`${currentDateStr}.json`);
      
      // 5. Render
      renderStories(newsData);
      renderArchives(indexData, currentDateStr);
      
      loading.style.display = 'none';
      
    } catch (e) {
      console.error(e);
      loading.style.display = 'none';
      error.style.display = 'block';
    }
  }

  // Run
  init();
</script>
