---
import Layout from '../layouts/Layout.astro';
---

<Layout>
  <main>
    {/* Headless Masthead */}
    <header class="masthead text-center">
      <h1 class="page-title">Kids News</h1>
      <div style="margin-top: 2rem;">
        <p id="news-date" style="font-size: 0.9rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.1em; color: var(--color-muted); display: none;"></p>
      </div>
    </header>

    <nav id="category-nav" class="category-nav" style="display: none;">
      {/* Category buttons will be injected here */}
    </nav>

    <hr style="border: 0; border-top: 1px solid var(--color-border); margin-top: 2rem; margin-bottom: 3rem;" />

    {/* Loading State */}
    <div id="loading" class="text-center" style="margin: 2rem 0;">
      <p>Loading the latest news...</p>
    </div>

    {/* Error State */}
    <div id="error" class="text-center" style="color: red; display: none;">
      <p>Could not load news. Please check back later!</p>
    </div>

    {/* Stories Container */}
    <section id="stories-container">
      {/* Stories will be injected here via JavaScript */}
    </section>

    {/* Archives Footer */}
    <footer id="archive-footer" class="archive-footer" style="display: none;">
      <h3 class="archive-title">Past days</h3>
      <ul id="archive-list" class="archive-list">
        {/* Archive links injected here */}
      </ul>
    </footer>
  </main>
</Layout>

<script>
  // TODO: Replace with your actual S3 Bucket URL after you create it in AWS Console
  // Example: https://personal-site-news-yourname.s3.us-east-1.amazonaws.com
  const S3_BASE_URL = 'https://amzn-s3-news-demo-bucket.s3.us-east-2.amazonaws.com';

  async function fetchJson(filename) {
    const response = await fetch(`${S3_BASE_URL}/${filename}`);
    if (!response.ok) throw new Error(`Failed to fetch ${filename}`);
    return await response.json();
  }

  let currentCategory = 'all';
  let newsDataGlobal = null;

  function renderCategories(newsData) {
    const nav = document.getElementById('category-nav');
    if (!newsData.categories) return;
    
    // Filter out categories with 0 stories
    const categories = Object.entries(newsData.categories).filter(([id, data]) => 
      data.stories && data.stories.length > 0
    );

    if (categories.length === 0) {
      nav.style.display = 'none';
      return;
    }
    
    nav.innerHTML = '';
    nav.style.display = 'flex';
    
    // 1. Add "Top Stories" first if it exists and has news
    const topEntry = categories.find(([id]) => id === 'top');
    if (topEntry) {
      const [categoryId, categoryData] = topEntry;
      const btn = document.createElement('button');
      btn.className = currentCategory === categoryId ? 'category-btn active' : 'category-btn';
      btn.textContent = categoryData.name;
      btn.onclick = (e) => filterByCategory(categoryId, e.target);
      nav.appendChild(btn);
    }
    
    // 2. Add other valid categories
    for (const [categoryId, categoryData] of categories) {
      if (categoryId === 'top') continue;
      const btn = document.createElement('button');
      btn.className = currentCategory === categoryId ? 'category-btn active' : 'category-btn';
      btn.textContent = categoryData.name;
      btn.onclick = (e) => filterByCategory(categoryId, e.target);
      nav.appendChild(btn);
    }

    // 3. Add "All" button last
    const allBtn = document.createElement('button');
    allBtn.className = currentCategory === 'all' ? 'category-btn active' : 'category-btn';
    allBtn.textContent = 'All';
    allBtn.onclick = (e) => filterByCategory('all', e.target);
    nav.appendChild(allBtn);
  }

  function filterByCategory(category, target) {
    currentCategory = category;
    
    // Update active button
    document.querySelectorAll('.category-btn').forEach(btn => {
      btn.classList.remove('active');
    });
    if (target) target.classList.add('active');
    
    renderStories(newsDataGlobal);
  }

  function renderStories(newsData) {
    const container = document.getElementById('stories-container');
    container.innerHTML = '';

    // Update global date
    const dateEl = document.getElementById('news-date');
    if (dateEl && (newsData.display_date || newsData.date)) {
        dateEl.textContent = newsData.display_date || newsData.date;
        dateEl.style.display = 'block';
    }

    if (!newsData.categories) {
      renderStoriesLegacy(newsData);
      return;
    }

    // Determine which categories to show
    const categoriesToShow = currentCategory === 'all' 
      ? Object.entries(newsData.categories)
      : [[currentCategory, newsData.categories[currentCategory]]];

    let storiesTotal = 0;

    categoriesToShow.forEach(([categoryId, categoryData]) => {
      if (!categoryData || !categoryData.stories || categoryData.stories.length === 0) return;
      
      storiesTotal += categoryData.stories.length;

      // Add category header if showing all
      if (currentCategory === 'all') {
        const header = document.createElement('h3');
        header.className = 'category-header';
        header.textContent = categoryData.name;
        container.appendChild(header);
      }
      
      categoryData.stories.forEach(story => {
        const article = document.createElement('article');
        article.className = 'news-article';

        const sectionsHtml = story.section.map(para => `<p>${para}</p>`).join('');
        
        let domain = '';
        try {
          if (story.link) {
            domain = new URL(story.link).hostname.replace('www.', '');
          }
        } catch (e) {}

        let attribution = story.source || (domain ? `Source: ${domain}` : 'Original Article');
        if (domain && (domain.includes('bbc.co.uk') || domain.includes('bbci.co.uk') || domain.includes('bbc.com'))) {
          attribution = 'BBC News';
        }

        const sourceLink = (story.link && story.link !== '#') 
          ? `<a href="${story.link}" target="_blank" rel="noopener noreferrer" class="source-link">${attribution}</a>`
          : `<span class="source-link">${attribution}</span>`;

        article.innerHTML = `
          <h2 class="news-heading">${story.title}</h2>
          <p class="meta-info">
            ${story.location}
            ${sourceLink ? ` • ${sourceLink}` : ''}
          </p>
          <div class="news-content">
            ${sectionsHtml}
          </div>
          <div class="why-it-matters">
            <span class="why-label">Why it matters</span>
            <p>${story.why_it_matters || ''}</p>
          </div>
        `;
        container.appendChild(article);
      });
    });

    if (storiesTotal === 0) {
      container.innerHTML = `
        <div class="text-center" style="margin: 4rem 0; color: var(--color-muted);">
          <p style="font-size: 1.25rem; font-weight: 500;">No news stories found for this category today.</p>
          <p style="margin-top: 0.5rem;">Please try selecting a different category or check back later.</p>
        </div>
      `;
    }
  }

  function renderStoriesLegacy(newsData) {
    // Old format compatibility
    const container = document.getElementById('stories-container');
    newsData.stories.forEach(story => {
      const article = document.createElement('article');
      article.className = 'news-article';

      const sectionsHtml = story.section.map(para => `<p>${para}</p>`).join('');
      
        let domain = '';
        try {
          if (story.link) {
            domain = new URL(story.link).hostname.replace('www.', '');
          }
        } catch (e) {}

        let attribution = story.source || (domain ? `Source: ${domain}` : 'Original Article');
        if (domain && (domain.includes('bbc.co.uk') || domain.includes('bbci.co.uk') || domain.includes('bbc.com'))) {
          attribution = 'BBC News';
        }

        const sourceLink = (story.link && story.link !== '#') 
          ? `<a href="${story.link}" target="_blank" rel="noopener noreferrer" class="source-link">${attribution}</a>`
          : `<span class="source-link">${attribution}</span>`;

      article.innerHTML = `
        <h2 class="news-heading">${story.title}</h2>
        <p class="meta-info">
          ${story.location}
          ${sourceLink ? ` • ${sourceLink}` : ''}
        </p>
        <div class="news-content">
          ${sectionsHtml}
        </div>
        <div class="why-it-matters">
          <span class="why-label">Why it matters</span>
          <p>${story.why_it_matters || ''}</p>
        </div>
      `;
      container.appendChild(article);
    });
  }

  function renderArchives(indexData, currentFile) {
    const footer = document.getElementById('archive-footer');
    const list = document.getElementById('archive-list');
    
    // Filter out current file and sort simple string dates
    // Assuming indexData.archive is list of "YYYY-MM-DD"
    // Also include 'latest' if we are viewing an archive
    
    // Combine all dates unique
    const allDates = [...new Set([...(indexData.archive || []), indexData.latest])];
    
    // Simple verification content exists
    if (allDates.length <= 1) return; 

    footer.style.display = 'block';
    list.innerHTML = '';

    allDates.sort().reverse().forEach(date => {
       // logic: if date is the one we are viewing, skip or mark active? 
       // For now just list others
       if (date === currentDateStr) return; 

       const li = document.createElement('li');
       const a = document.createElement('a');
       a.href = `/?date=${date}`;
       a.className = 'archive-link';
       a.textContent = date;
       li.appendChild(a);
       list.appendChild(li);
    });
  }
  
  // Global state
  let currentDateStr = '';

  async function init() {
    const loading = document.getElementById('loading');
    const error = document.getElementById('error');
    
    try {
      // 1. Get query param
      const urlParams = new URLSearchParams(window.location.search);
      const queryDate = urlParams.get('date');

      // 2. Fetch Index
      const indexData = await fetchJson('index.json');
      
      // 3. Determine target date
      currentDateStr = queryDate || indexData.latest;
      
      // 4. Fetch News
      const newsData = await fetchJson(`${currentDateStr}.json`);
      newsDataGlobal = newsData;
      
      // 5. Render
      renderCategories(newsData);
      renderStories(newsData);
      renderArchives(indexData, currentDateStr);
      
      loading.style.display = 'none';
      
    } catch (e) {
      console.error(e);
      loading.style.display = 'none';
      error.style.display = 'block';
    }
  }

  // Run
  init();
</script>
